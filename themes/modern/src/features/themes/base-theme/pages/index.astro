---
import { loadGalleryData, resolveGalleryData } from '@simple-photo-gallery/common/theme';

import CtaBanner from '@/features/themes/base-theme/components/cta/CtaBanner.astro';
import Footer from '@/features/themes/base-theme/components/footer/Footer.astro';
import GallerySection from '@/features/themes/base-theme/components/gallery-section/GallerySection.astro';
import Hero from '@/features/themes/base-theme/components/hero/Hero.astro';
import PhotoSwipe from '@/features/themes/base-theme/components/lightbox/PhotoSwipe.astro';
import SubGalleries from '@/features/themes/base-theme/components/sub-galleries/SubGalleries.astro';
import MainLayout from '@/features/themes/base-theme/layouts/MainLayout.astro';

// Load and resolve gallery data - all paths are pre-computed
const raw = loadGalleryData();
const gallery = await resolveGalleryData(raw);

const showCtaBanner = gallery.ctaBanner === true;
---

<script>
  import { decodeAllBlurhashes } from '@simple-photo-gallery/common/client';

  import { applyQueryParams } from '@/features/themes/base-theme/utils/queryParams';

  // Decode all blurhash canvases on the page
  decodeAllBlurhashes();

  // Apply query parameter customizations
  applyQueryParams();
</script>

<MainLayout
  title={gallery.title}
  description={gallery.hero.description}
  metadata={gallery.metadata}
  url={gallery.url}
  thumbsBaseUrl={gallery.thumbsBaseUrl}
  analyticsScript={gallery.analyticsScript}
  headerImage={gallery.hero.headerImage}
  headerImageVariants={gallery.hero.headerImageVariants}>
  <Hero hero={gallery.hero} />

  {
    gallery.subGalleries && gallery.subGalleries.galleries.length > 0 && (
      <SubGalleries title={gallery.subGalleries.title} subGalleries={gallery.subGalleries.galleries} />
    )
  }
  {gallery.sections.map((section, sectionIndex) => <GallerySection section={section} sectionIndex={sectionIndex} />)}

  {showCtaBanner && <CtaBanner />}

  <Footer />
  <PhotoSwipe />
</MainLayout>
